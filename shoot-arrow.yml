---
- name: Arrow | Debug information to remove.
  debug:
    msg: |
      The arrow is in room {{ arrow }}.
      It can reach rooms: {{ cave[arrow]['connect'] }}.
      Target is room: {{ nextroom }}.
    verbosity: 1

- name: Arrow | Is the arrow not too far?
  set_fact:
    failarrow: yes
  when: roomcnt == 4

- name: Arrow | Gready shot.
  debug:
    msg: |
      The arrow wavers in its flight and can go no further than room {{ arrow }}
  when: failarrow

- name: Arrow | Can the arrow fly to the next room?
  assert:
    that:
      - "nextroom in cave[arrow]['connect']"
    fail_msg: "no"
    success_msg: "yes"
    quiet: yes
  failed_when: no
  register: canitfly
  when: not failarrow

- name: Arrow | Yes.
  when:
    - canitfly is defined
    - canitfly.msg is defined
    - canitfly.msg|bool
    - not failarrow
  block:
    - name: Yes | Define arrow position.
      set_fact:
        arrow: "{{ nextroom }}"
    - name: Yes | Debug message to remove.
      debug:
        msg: "The arrow fly away to room {{ nextroom }}."
        verbosity: 1

- name: Arrow | No.
  when:
    - canitfly is defined
    - canitfly.msg is defined
    - not canitfly.msg|bool
    - not failarrow
  block:
    - name: No | Pick a random room to fly to.
      set_fact:
        randomroom: "{{ cave[arrow]['connect']| random }}"

    - name: No | Thunk
      debug:
        msg: "*thunk*  The arrow can't find a way from {{ position }} to {{ nextroom }} and flies randomly into room {{ randomroom }}!"

    - name: No | Define arrow position.
      set_fact:
        arrow: "{{ randomroom }}"

- name: Arrow | Does the arrow hit the Wumpus?
  set_fact:
    hit: true
  when:
    - not failarrow
    - cave[arrow]['wumpus']

- name: Arrow | Player is so bad.
  when: not failarrow
  block:
    - name: Arrow | Does the arrow hit the Player?
      set_fact:
        death: yes
      when: arrow == position
    - include_tasks: the-end.yml
      when: death

- name: Arrow | Is it the last room?
  debug:
    msg: "The arrow hit nothing."
  when:
    - not failarrow
    - ansible_loop.last
    - hit is defined
    - not hit
